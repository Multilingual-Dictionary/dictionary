
<!DOCTYPE html>
<% @admin_job= 'export_glossary' %>
<%= render 'layouts/admin_header' %>

<html>

<style>
 #select_dicts {
    margin-left:+50px;
	background-color:#99ccff;
 }
</style>

<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
function update_progress_bar( progress){

	var progress_bar = document.getElementById("progress_bar");
	var progress_msg = document.getElementById("progress_msg");
	var percent=progress.percent;
	if (percent<1){
		percent=1;
	}
	progress_bar.setAttribute("aria-valuenow",percent);
	progress_bar.setAttribute("style","width:"+percent+"%");
	progress_msg.innerHTML= progress.stage + " " + progress.message;
	progress_bar.innerHTML = progress.percent+"%";
	document.getElementById("job_status").value=progress.status;
	if(progress.status=="done"){
		document.getElementById("this_form").submit();
    }
}
function get_progress(){
	var job_id;
	job_id = document.getElementById("job_id").value;
	job_status = document.getElementById("job_status").value;
	if(job_id!="0" & job_status != 'done'){
		$.ajax({
			url: "/progress?id="+job_id,
			dataType: "json",
			success: function(result){
				update_progress_bar(result);
				console.log(result);
				console.log(result.id);
		}});
	}
}
function check_all(id) {
    var all_dicts;
	if(document.getElementById(id).checked != true){
	  to_set=false
	} else {
	  to_set=true
	}
	all_dicts=document.getElementById("all_dicts").value.split(";") ;
	for(index=0;index<all_dicts.length-1;++index){
		document.getElementById(all_dicts[index]).checked = to_set; 
	}
}
$(document).ready(function(){
	setInterval(get_progress, 1000);
});
</script>
</head>

<body>

<% src_lang_opt = []
   tgt_lang_opt = []
   @dictionaries.src_lang_supported.each{|k,v|
      src_lang_opt << [v,k]
   }
   @dictionaries.tgt_lang_supported.each{|k,v|
      tgt_lang_opt << [v,k]
   }
%>
<%= form_with url: '/export_glossary/export', method: :get, id: "this_form" , local: true do |f| %>

  <%= hidden_field_tag("job_id",params[:job_id]) %>
  <%= hidden_field_tag("job_status",params[:job_status]) %>
  <label>Ngôn ngữ gốc</label>
  <%= select_tag(
	"src_lang", options_for_select(src_lang_opt,params[:src_lang]), 
	{ "selected" => params[:src_lang],
	                   "onchange" => "this.form.submit();"} ) %>

  <label> Ngôn ngữ dịch</label>
    <%= select_tag(
	"tgt_lang", options_for_select(tgt_lang_opt,params[:tgt_lang]), 
	{ "selected" => params[:tgt_lang],
	                   "onchange" => "this.form.submit();"} ) %>

<br/>

<label>
        Chọn tự điển
</label>


<div id="select_dicts" style="display: block" >


<% all_dicts="" %>
<input class="form-check-input" type="checkbox" value="ON" 
	    name="dicts_check"
	    id="dicts_check"
		onchange="check_all('dicts_check')" 
<% if @selected_dicts.length>1 %>
        CHECKED
<% end %>
		
     >
<label class="form-check-label" for="dicts_check">
        Chọn tất cả các tự điển [ hay bỏ chọn ] 
</label>
<% @dict_list.each(){|n,inf| %>
<% all_dicts << n << ";" %>
   <div class="form-check">
     <input class="form-check-input" type="checkbox" value="ON" 
	    name="<%="CHK"+inf["dict_sys_name"]%>"
	    id="<%=inf["dict_sys_name"]%>"
		<% if @selected_dicts.has_key?(inf["dict_sys_name"]) %>
		CHECKED
		<% end %>
     >
     <label class="form-check-label" for="<%=inf["dict_sys_name"]%>">
        <%=inf["dict_name"]%>
     </label>
   </div>
<% } %>
<%=hidden_field_tag 'all_dicts',all_dicts %>
</div>
<hr/>
<%= submit_tag("Kết xuất") %>
<% if params[:job_id] != "0" and params[:job_status]== "done" %>
<div id="download" >
<%= submit_tag("Tải về") %>
</div>
<% end %>

<% if params[:job_id] != "0" and params[:job_status]!= "done" %>

<div class="container-fluid">
 <div class="row">
  <div id="progress_msg" class="col-sm-4" %>
  </div>
  <div class="progress col-sm-8">
    <div id="progress_bar" class="progress-bar progress-bar-striped active" role="progressbar"
     aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width:0%">
    </div>
  <div>
  
 </div> 
</div>

<%end%>



<%end%>
</body>

</html>